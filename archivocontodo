<?php

# /src/Entity/Club.php

    namespace App\Entity;

    use App\Repository\ClubRepository;
    use Doctrine\Common\Collections\ArrayCollection;
    use Doctrine\Common\Collections\Collection;
    use Doctrine\ORM\Mapping as ORM;
    use Symfony\Component\Validator\Constraints as Assert;

    /**
     * @ORM\Entity(repositoryClass=ClubRepository::class)
     */
    class Club
    {
        /**
         * @ORM\Id
         * @ORM\GeneratedValue
         * @ORM\Column(type="integer")
         */
        private $id;

        /**
         * @ORM\Column(type="string", length=255)
         * @Assert\NotBlank(message="El nombre no puede estar vacío.")
         * @Assert\Length(
         *     min=2,
         *     max=255,
         *     minMessage="El nombre debe tener al menos {{ limit }} caracteres",
         *     maxMessage="El nombre no puede tener más de {{ limit }} caracteres"
         * )
         */
        private $name;

        /**
         * @ORM\Column(type="float", nullable=true)
         * @Assert\NotBlank(message="El presupuesto no puede estar vacío")
         * @Assert\Positive(message="El presupuesto debe ser un número positivo")
         */
        private $budget;

        /**
         * @ORM\OneToMany(targetEntity=Player::class, mappedBy="club")
         */
        private $players;

        /**
         * @ORM\OneToMany(targetEntity=Coach::class, mappedBy="club")
         */
        private $coaches;

        public function __construct()
        {
            $this->players = new ArrayCollection();
            $this->coaches = new ArrayCollection();
        }

        // Getters and Setters
        public function getId(): ?int
        {
            return $this->id;
        }

        public function getName(): ?string
        {
            return $this->name;
        }

        public function setName(string $name): self
        {
            $this->name = $name;

            return $this;
        }

        public function getBudget(): ?float
        {
            return $this->budget;
        }

        public function setBudget(float $budget): self
        {
            $this->budget = $budget;

            return $this;
        }
        
        /**
         * @return Collection<int, Player>
         */
        public function getPlayers(): Collection
        {
            return $this->players;
        }

        public function addPlayer(Player $player): self
        {
            if (!$this->players->contains($player)) {
                $this->players[] = $player;
                $player->setClub($this);
            }

            return $this;
        }

        public function removePlayer(Player $player): self
        {
            if ($this->players->removeElement($player)) {
                if ($player->getClub() === $this) {
                    $player->setClub(null);
                }
            }

            return $this;
        }

        /**
         * @return Collection<int, Coach>
         */
        public function getCoaches(): Collection
        {
            return $this->coaches;
        }

        public function addCoach(Coach $coach): self
        {
            if (!$this->coaches->contains($coach)) {
                $this->coaches[] = $coach;
                $coach->setClub($this);
            }

            return $this;
        }

        public function removeCoach(Coach $coach): self
        {
            if ($this->coaches->removeElement($coach)) {
                if ($coach->getClub() === $this) {
                    $coach->setClub(null);
                }
            }

            return $this;
        }

        public function calculateTotalSalaries(): float
        {
            $total = 0;

            foreach ($this->players as $player) {
                $total += $player->getSalary() ?? 0;
            }

            foreach ($this->coaches as $coach) {
                $total += $coach->getSalary() ?? 0;
            }

            return $total;
        }
    }




# /src/Controller/ClubController.php

    namespace App\Controller;

    use Symfony\Bundle\FrameworkBundle\Controller\AbstractController;
    use Symfony\Component\HttpFoundation\JsonResponse;
    use Symfony\Component\HttpFoundation\Request;
    use Symfony\Component\Routing\Annotation\Route;
    use Symfony\Component\Validator\Validator\ValidatorInterface;
    use App\Service\ClubService;
    use App\Entity\Club;
    use App\Exception\ClubNotFoundException;
    use App\Exception\PlayerNotFoundException;
    use App\Exception\CoachNotFoundException;
    use App\Exception\AlreadyInClubException;
    use App\Exception\InsufficientBudgetException;
    use Doctrine\ORM\Query\QueryException;

    /**
     * @Route("/api/clubs")
     */
    class ClubController extends AbstractController
    {
        /**
         * @Route("", methods={"POST"}, name="create_club")
         */
        public function createClub(Request $request, ClubService $clubService, ValidatorInterface $validator): JsonResponse
        {
            $data = json_decode($request->getContent(), true);

            $club = new Club();
            $club->setName($data['name']);
            $club->setBudget($data['budget']);

            $errors = $validator->validate($club);

            if (count($errors) > 0) {
                return $this->json(['errors' => $this->formatErrors($errors)], 400);
            }

            $clubService->createClub($club);

            return $this->json($club, 201);
        }

        /**
         * @Route("/{clubId}/players/{playerId}", methods={"POST"}, name="add_player_to_club")
         */
        public function addPlayerToClub(int $clubId, int $playerId, ClubService $clubService): JsonResponse
        {
            try {
                $clubService->addPlayerToClub($clubId, $playerId);
                return $this->json(['message' => 'Jugador añadido al club exitosamente'], 200);
            } catch (ClubNotFoundException $e) {
                return $this->json(['error' => $e->getMessage()], $e->getStatusCode());
            } catch (PlayerNotFoundException $e) {
                return $this->json(['error' => $e->getMessage()], $e->getStatusCode());
            } catch (AlreadyInClubException $e) {
                return $this->json(['error' => $e->getMessage()], $e->getStatusCode());
            } catch (InsufficientBudgetException $e) {
                return $this->json(['error' => $e->getMessage()], $e->getStatusCode());
            } catch (\Exception $e) {
                return $this->json(['error' => 'Error inesperado'], 500);
            }

            return $this->json(null, 204);
        }

        /**
         * @Route("/{clubId}/coaches/{coachId}", methods={"POST"}, name="add_coach_to_club")
         */
        public function addCoachToClub(int $clubId, int $coachId, ClubService $clubService): JsonResponse
        {
            try {
                $clubService->addCoachToClub($clubId, $coachId);
                return $this->json(['message' => 'Entrenador añadido al club exitosamente'], 200);
            } catch (ClubNotFoundException $e) {
                return $this->json(['error' => $e->getMessage()], $e->getStatusCode());
            } catch (CoachNotFoundException $e) {
                return $this->json(['error' => $e->getMessage()], $e->getStatusCode());
            } catch (AlreadyInClubException $e) {
                return $this->json(['error' => $e->getMessage()], $e->getStatusCode());
            } catch (InsufficientBudgetException $e) {
                return $this->json(['error' => $e->getMessage()], $e->getStatusCode());
            } catch (\Exception $e) {
                return $this->json(['error' => 'Error inesperado'], 500);
            }

            return $this->json(null, 204);
        }

        /**
         * @Route("/{id}/budget", methods={"PATCH"}, name="update_club_budget")
         */
        public function updateClubBudget(int $id, Request $request, ClubService $clubService): JsonResponse
        {
            $data = json_decode($request->getContent(), true);
            $delta = $data['salaryImpact'] ?? null;

            if ($delta === null || !is_numeric($delta)) {
                return $this->json(['error' => "Introduce un campo 'salaryImpact' con la cantidad que deseas sumar o restar"], 400);
            }

            try {
                $updatedBudget = $clubService->updateClubBudget($id, (float)$delta);
            } catch (ClubNotFoundException $e) {
                return $this->json(['error' => $e->getMessage()], $e->getStatusCode());
            } catch (\Exception $e) {
                return $this->json(['error' => 'Error inesperado'], 500);
            }

            return $this->json([
                'message' => 'Presupuesto actualizado.',
                'currentBudget' => $updatedBudget
            ]);
        }
        // public function updateClubBudget(int $id, ClubService $clubService): JsonResponse
        // {
        //     try {
        //         $updatedBudget = $clubService->updateClubBudget($id);
        //     } catch (ClubNotFoundException $e) {
        //         return $this->json(['error' => $e->getMessage()], $e->getStatusCode());
        //     } catch (\Exception $e) {
        //         return $this->json(['error' => 'Error inesperado'], 500);
        //     }

        //     return $this->json([
        //         'message' => 'El presupuesto ha sido actualizado.',
        //         'currentBudget' => $updatedBudget
        //     ], 200);
        // }

        /**
         * @Route("/{clubId}/players/{playerId}", methods={"DELETE"}, name="remove_player_from_club")
         */
        public function removePlayerFromClub(int $clubId, int $playerId, ClubService $clubService): JsonResponse
        {
            try {
                $clubService->removePlayerFromClub($clubId, $playerId);
                return $this->json(['message' => 'Jugador eliminado del club exitosamente'], 200);
            } catch (ClubNotFoundException $e) {
                return $this->json(['error' => $e->getMessage()], 404);
            } catch (PlayerNotFoundException $e) {
                return $this->json(['error' => $e->getMessage()], 404);
            } catch (\InvalidArgumentException $e) {
                return $this->json(['error' => $e->getMessage()], 404);
            } catch (\Exception $e) {
                return $this->json(['error' => 'Error inesperado'], 500);
            }
        }

        /**
         * @Route("/{clubId}/coaches/{coachId}", methods={"DELETE"}, name="remove_coach_from_club")
         */
        public function removeCoachFromClub(int $clubId, int $coachId, ClubService $clubService): JsonResponse
        {
            try {
                $clubService->removeCoachFromClub($clubId, $coachId);
                return $this->json(['message' => 'Entrenador eliminado del club exitosamente'], 200);
            } catch (ClubNotFoundException $e) {
                return $this->json(['error' => $e->getMessage()], 404);
            } catch (CoachNotFoundException $e) {
                return $this->json(['error' => $e->getMessage()], 404);
            } catch (\InvalidArgumentException $e) {
                return $this->json(['error' => $e->getMessage()], 404);
            } catch (\Exception $e) {
                return $this->json(['error' => 'Error inesperado'], 500);
            }
        }

        /**
         * @Route("/{clubId}/players", methods={"GET"}, name="get_club_players")
         */
        public function getClubPlayers(int $clubId, Request $request, ClubService $clubService): JsonResponse
        {
            // Parámetros de la solicitud
            $page = $request->query->getInt('page', 1);
            $limit = $request->query->getInt('limit', 10);
            $filters = $request->query->all('filter');

            try {
                $result = $clubService->getClubPlayers($clubId, $page, $limit, $filters);
                return $this->json($result);
            } catch (ClubNotFoundException $e) {
                return $this->json(['error' => $e->getMessage()], 404);
            } catch (PlayerNotFoundException $e) {
                return $this->json(['error' => $e->getMessage()], 404); // <-- Nuevo catch
            } catch (QueryException $e) {
                return $this->json(['error' => $e->getMessage()], 500);
            }
        }

        private function formatErrors($errors): array
        {
            $errorMessages = [];
            foreach ($errors as $error) {
                $errorMessages[] = $error->getMessage();
            }
            return $errorMessages;
        }
    }



# /src/Service/ClubService.php

    namespace App\Service;

    use Doctrine\ORM\EntityManagerInterface;
    use App\Entity\Club;
    use App\Repository\ClubRepository;
    use App\Repository\PlayerRepository;
    use App\Repository\CoachRepository;
    use App\Exception\InsufficientBudgetException;
    use App\Exception\ClubNotFoundException;
    use App\Exception\PlayerNotFoundException;
    use App\Exception\CoachNotFoundException;
    use App\Exception\AlreadyInClubException;
    use Doctrine\ORM\Tools\Pagination\Paginator;

    class ClubService
    {
        private $entityManager;
        private $clubRepository;
        private $playerRepository;
        private $coachRepository;

        public function __construct(
            EntityManagerInterface $entityManager,
            ClubRepository $clubRepository,
            PlayerRepository $playerRepository,
            CoachRepository $coachRepository,
        ) {
            $this->entityManager = $entityManager;
            $this->clubRepository = $clubRepository;
            $this->playerRepository = $playerRepository;
            $this->coachRepository = $coachRepository;
        }

        public function createClub(Club $club): Club
        {
            $this->entityManager->persist($club);
            $this->entityManager->flush();
            return $club;
        }

        public function addPlayerToClub(int $clubId, int $playerId): void
        {
            $club = $this->clubRepository->find($clubId);
            $player = $this->playerRepository->find($playerId);

            if (!$club) {
                throw new ClubNotFoundException();
            } else if (!$player) {
                throw new PlayerNotFoundException();
            } else if ($player->getClub()) {
                throw new AlreadyInClubException();
            }

            $salary = $player->getSalary();
            $totalSalaries = $club->calculateTotalSalaries() + $salary;

            if ($totalSalaries > $club->getBudget()) {
                throw new InsufficientBudgetException();
            }

            $player->setClub($club);
            $player->setSalary($salary);
            $this->entityManager->flush();
        }

        public function addCoachToClub(int $clubId, int $coachId): void
        {
            $club = $this->clubRepository->find($clubId);
            $coach = $this->coachRepository->find($coachId);
            $salary = $coach->getSalary();

            if (!$club) {
                throw new ClubNotFoundException();
            } else if (!$coach) {
                throw new CoachNotFoundException();
            } else if ($coach->getClub()) {
                throw new AlreadyInClubException();
            }

            $totalSalaries = $club->calculateTotalSalaries() + $salary;

            if ($totalSalaries > $club->getBudget()) {
                throw new InsufficientBudgetException();
            }

            $coach->setClub($club);
            $coach->setSalary($salary);
            $this->entityManager->flush();
        }

        private function calculateTotalSalaries(Club $club): float
        {
            $total = 0;

            foreach ($club->getPlayers() as $player) {
                $total += $player->getSalary() ?? 0;
            }

            foreach ($club->getCoaches() as $coach) {
                $total += $coach->getSalary() ?? 0;
            }

            return $total;
        }

        public function updateClubBudget(int $clubId, float $salaryImpact): float
        {
            $club = $this->clubRepository->find($clubId);

            if (!$club) {
                throw new ClubNotFoundException();
            }

            $currentBudget = $club->getBudget();
            $newBudget = $currentBudget + $salaryImpact;

            if ($newBudget < 0) {
                throw new \Exception('El presupuesto no puede ser negativo.');
            }

            $club->setBudget($newBudget);
            $this->entityManager->flush();

            return $newBudget;
        }
        // public function updateClubBudget(int $clubId): float
        // {
        //     $club = $this->clubRepository->find($clubId);

        //     if (!$club) {
        //         throw new ClubNotFoundException();
        //     }

        //     $clubBudget = $club->getBudget();
        //     $currentSalaries = $this->calculateTotalSalaries($club);
        //     $newBudget = $clubBudget - $currentSalaries;

        //     $club->setBudget($newBudget);
        //     $this->entityManager->flush();

        //     return $newBudget;
        // }

        public function removePlayerFromClub(int $clubId, int $playerId): void
        {
            $club = $this->clubRepository->find($clubId);
            $player = $this->playerRepository->find($playerId);

            if (!$club) {
                throw new ClubNotFoundException();
            } else if (!$player) {
                throw new PlayerNotFoundException();
            } else if ($player->getClub() !== $club) {
                throw new \InvalidArgumentException("El jugador no pertenece a este club");
            }

            $player->setClub(null);
            $player->setSalary(0);
            $this->entityManager->flush();
        }

        public function removeCoachFromClub(int $clubId, int $coachId): void
        {
            $club = $this->clubRepository->find($clubId);
            $coach = $this->coachRepository->find($coachId);

            if (!$club) {
                throw new ClubNotFoundException();
            } else if (!$coach) {
                throw new CoachNotFoundException();
            } else if ($coach->getClub() !== $club) {
                throw new \InvalidArgumentException("El entrenador no pertenece a este club");
            }

            $coach->setClub(null);
            $coach->setSalary(0);
            $this->entityManager->flush();
        }

        /**
         * Lista jugadores de un club con filtrado y paginación
         * 
         * @param int $clubId
         * @param int $page
         * @param int $limit
         * @return array $filters Ejemplo: ['name' => 'CR7']
         * @return array
         */
        public function getClubPlayers(int $clubId, int $page, int $limit, array $filters = []): array
        {
            // 1. Verificar que el club exista
            $club = $this->clubRepository->find($clubId);
            if (!$club) {
                throw new ClubNotFoundException();
            }

            // 2. Construir la consulta con filtros
            $queryBuilder = $this->playerRepository->createQueryBuilder('p')
                ->andWhere('p.club = :clubId')
                ->setParameter('clubId', $club)
                ->orderBy('p.id', 'ASC');

            // 2.1. Aplicar filtros dinámicos (ej: por nombre)
            $filterByName = $filters['name'] ?? null;
            if (!empty($filterByName)) {
                $queryBuilder
                    ->andWhere('p.name LIKE :name')
                    ->setParameter('name', '%' . $filterByName . '%');
            }

            $query = $queryBuilder->getQuery();

            // Depuración: Imprime la consulta SQL y los parámetros
            dump($query->getSQL(), $query->getParameters());

            $paginator = new Paginator($query);

            // 3. Paginación
            $query = $queryBuilder->getQuery()
                ->setFirstResult(($page - 1) * $limit)
                ->setMaxResults($limit);

            $paginator = new Paginator($query);
            $total = count($paginator);

            // 4. Formatear resultados (solo id y nombre)
            $players = [];
            foreach ($paginator as $player) {
                $players[] = [
                    'id' => $player->getId(),
                    'name' => $player->getName(),
                ];
            }

            if (!empty($filterByName) && $total === 0) {
                throw new PlayerNotFoundException();
            }

            return [
                'players' => $players,
                'total' => $total,
                'page' => $page,
                'total_pages' => ceil($total / $limit),
            ];
        }
    }



# /src/Entity/Player.php

    namespace App\Entity;

    use App\Repository\PlayerRepository;
    use Doctrine\ORM\Mapping as ORM;
    use Symfony\Component\Validator\Constraints as Assert;

    /**
     * @ORM\Entity(repositoryClass=PlayerRepository::class)
     */
    class Player
    {
        /**
         * @ORM\Id
         * @ORM\GeneratedValue
         * @ORM\Column(type="integer")
         */
        private $id;

        /**
         * @ORM\Column(type="string", length=255)
         * @Assert\NotBlank(message="El nombre no puede estar vacío")
         * @Assert\Length(
         *     min=2,
         *     max=255,
         *     minMessage="El nombre debe tener al menos {{ limit }} caracteres",
         *     maxMessage="El nombre no puede tener más de {{ limit }} caracteres"
         * )
         */
        private $name;

        /**
         * @ORM\Column(type="integer")
         */
        private $age;

        /**
         * @ORM\Column(type="float")
         * @Assert\NotBlank(message="El salario no puede estar vacío")
         * @Assert\Positive(message="El salario debe ser un número positivo")
         */
        // private $salary;
        private ?float $salary = null;

        /**
         * @ORM\ManyToOne(targetEntity=Club::class, inversedBy="players")
         */
        private $club;

        // Getters and setters
        public function getId(): ?int
        {
            return $this->id;
        }

        public function getName(): ?string
        {
            return $this->name;
        }

        public function setName(string $name): self
        {
            $this->name = $name;

            return $this;
        }

        public function getAge(): ?int
        {
            return $this->age;
        }

        public function setAge(int $age): self
        {
            $this->age = $age;

            return $this;
        }

        public function getSalary(): ?float
        {
            return $this->salary;
        }

        public function setSalary(?float $salary): self
        {
            $this->salary = $salary;

            return $this;
        }

        public function getClub(): ?Club
        {
            return $this->club;
        }

        public function setClub(?Club $club): self
        {
            $this->club = $club;

            return $this;
        }
    }


# /src/Controller/PlayerController.php

    namespace App\Controller;

    use Symfony\Bundle\FrameworkBundle\Controller\AbstractController;
    use Symfony\Component\HttpFoundation\JsonResponse;
    use Symfony\Component\HttpFoundation\Request;
    use Symfony\Component\Routing\Annotation\Route;
    use Symfony\Component\Validator\Validator\ValidatorInterface;
    use Symfony\Component\HttpKernel\Exception\NotFoundHttpException;
    use App\Service\PlayerService;
    use App\Entity\Player;
    use App\Exception\PlayerNotFoundException;

    /**
     * @Route("/api/players")
     */
    class PlayerController extends AbstractController
    {
        /**
         * @Route("", methods={"POST"})
         */
        public function createPlayer(Request $request, PlayerService $playerService, ValidatorInterface $validator): JsonResponse
        {
            $data = json_decode($request->getContent(), true);

            $player = new Player();
            $player->setName($data['name'] ?? '');
            $player->setAge($data['age'] ?? 0);
            $player->setSalary($data['salary'] ?? null);

            $errors = $validator->validate($player, null, $player->getClub() ? ['Club'] : []);

            if (count($errors) > 0) {
                return $this->json(['errors' => $this->formatErrors($errors)], 400);
            }

            $playerService->createPlayer($player);

            return $this->json([
                'message' => 'Jugador creado exitosamente',
                'player' => $player
            ], 201);
        }

        /**
        * @Route("", methods={"GET"})
        */
        public function getPlayers(PlayerService $playerService): JsonResponse
        {
            $players = $playerService->getAllPlayers();
            return $this->json(['Lista total de jugadores creados' => $players], 200); // Serialización directa
        }

        /**
         * @Route("/{id}", methods={"DELETE"})
         */
        public function deletePlayer(int $id, PlayerService $playerService): JsonResponse
        {
            try {
                $playerService->deletePlayer($id);
                return $this->json(['message' => 'Jugador eliminado exitosamente'], 200);
            } catch (PlayerNotFoundException $e) {
                return $this->json(['error' => $e->getMessage()], $e->getStatusCode());
            }
        }

        private function formatErrors($errors): array
        {
            $errorMessages = [];
            foreach ($errors as $error) {
                $errorMessages[] = $error->getMessage();
            }
            return $errorMessages;
        }
    }

# /src/Service/PlayerService.php

    namespace App\Service;

    use App\Entity\Player;
    use App\Repository\PlayerRepository;
    use Doctrine\ORM\EntityManagerInterface;
    // use Doctrine\ORM\Tools\Pagination\Paginator;
    // use Symfony\Component\Serializer\Normalizer\NormalizerInterface;
    // use Symfony\Component\Serializer\Normalizer\AbstractNormalizer;
    use App\Exception\PlayerNotFoundException;


    class PlayerService
    {
        private $entityManager;
        private $playerRepository;
        // private $normalizer;

        public function __construct(
            EntityManagerInterface $entityManager,
            PlayerRepository $playerRepository,
            // NormalizerInterface $normalizer
        ) {
            $this->entityManager = $entityManager;
            $this->playerRepository = $playerRepository;
            // $this->normalizer = $normalizer;
        }

        public function createPlayer(Player $player): Player
        {
            $this->entityManager->persist($player);
            $this->entityManager->flush();
            return $player;
        }

        public function getAllPlayers(): array
        {
            return $this->playerRepository->createQueryBuilder('p')
                ->select('p.id', 'p.name')
                ->getQuery()
                ->getArrayResult();
        }

        public function deletePlayer(int $id): void
        {
            $player = $this->playerRepository->find($id);

            if (!$player) {
                throw new PlayerNotFoundException();
            }

            $this->entityManager->remove($player);
            $this->entityManager->flush();
        }
    }



# /src/Entity/Coach.php

    namespace App\Entity;

    use App\Repository\CoachRepository;
    use Doctrine\ORM\Mapping as ORM;
    use Symfony\Component\Validator\Constraints as Assert;

    /**
     * @ORM\Entity(repositoryClass=CoachRepository::class)
     */
    class Coach
    {
        /**
         * @ORM\Id
         * @ORM\GeneratedValue
         * @ORM\Column(type="integer")
         */
        private $id;

        /**
         * @ORM\Column(type="string", length=255)
         * @Assert\NotBlank(message="El nombre no puede estar vacío")
         * @Assert\Length(
         *     min=2,
         *     max=255,
         *     minMessage="El nombre debe tener al menos {{ limit }} caracteres",
         *     maxMessage="El nombre no puede tener más de {{ limit }} caracteres"
         * )
         */
        private $name;

        /**
         * @ORM\Column(type="integer")
         */
        private $age;

        /**
         * @ORM\Column(type="float")
         * @Assert\NotBlank(message="El salario no puede estar vacío")
         * @Assert\Positive(message="El salario debe ser un número positivo")
         */
        // private $salary;
        private ?float $salary = null;

        /**
         * @ORM\ManyToOne(targetEntity=Club::class, inversedBy="coaches")
         */
        private $club;

        // Getters and setters
        public function getId(): ?int
        {
            return $this->id;
        }

        public function getName(): ?string
        {
            return $this->name;
        }

        public function setName(string $name): self
        {
            $this->name = $name;

            return $this;
        }

        public function getAge(): ?int
        {
            return $this->age;
        }

        public function setAge(int $age): self
        {
            $this->age = $age;

            return $this;
        }

        public function getSalary(): ?float
        {
            return $this->salary;
        }

        public function setSalary(?float $salary): self
        {
            $this->salary = $salary;

            return $this;
        }

        public function getClub(): ?Club
        {
            return $this->club;
        }

        public function setClub(?Club $club): self
        {
            $this->club = $club;

            return $this;
        }
    }




# /src/Controller/CoachController.php

    namespace App\Controller;

    use Symfony\Bundle\FrameworkBundle\Controller\AbstractController;
    use Symfony\Component\HttpFoundation\JsonResponse;
    use Symfony\Component\HttpFoundation\Request;
    use Symfony\Component\Routing\Annotation\Route;
    use Symfony\Component\Validator\Validator\ValidatorInterface;
    use App\Exception\CoachNotFoundException;
    use App\Service\CoachService;
    use App\Entity\Coach;

    /**
     * @Route("/api/coaches")
     */
    class CoachController extends AbstractController
    {
        /**
         * @Route("", methods={"POST"})
         */
        public function createCoach(
            Request $request,
            CoachService $coachService,
            ValidatorInterface $validator
        ): JsonResponse {
            $data = json_decode($request->getContent(), true);

            $coach = new Coach();
            $coach->setName($data['name'] ?? '');
            $coach->setAge($data['age'] ?? 0);
            $coach->setSalary($data['salary'] ?? 0);

            $errors = $validator->validate($coach, null, $coach->getClub() ? ['Club'] : []);

            if (count($errors) > 0) {
                return $this->json(['errors' => $this->formatErrors($errors)], 400);
            }

            $coachService->createCoach($coach);

            return $this->json([
                'message' => 'Entrenador creado exitosamente',
                'coach' => $coach // Clave explícita
            ], 201);
        }

        /**
         * @Route("", methods={"GET"})
         */
        public function getAllCoaches(Request $request, CoachService $coachService): JsonResponse
        {
            $page = $request->query->getInt('page', 1);
            $limit = $request->query->getInt('limit', 10);

            $result = $coachService->getAllCoaches($page, $limit);

            return $this->json([
                'data' => $result['coaches'],
                'total' => $result['total'],
                'page' => $page,
                'limit' => $limit
            ]);
        }

        /**
         * @Route("/{id}", methods={"DELETE"})
         */
        public function deleteCoach(int $id, CoachService $coachService): JsonResponse
        {
            try {
                $coachService->deleteCoach($id);
                return $this->json(['message' => 'Entrenador eliminado exitosamente'], 200);
            } catch (CoachNotFoundException $e) {
                return $this->json(['error' => $e->getMessage()], $e->getStatusCode());
            }
        }

        private function formatErrors($errors): array
        {
            $errorsResponse = [];

            foreach ($errors as $error) {
                $errorsResponse[$error->getPropertyPath()] = $error->getMessage();
            }

            return $errorsResponse;
        }
    }



# /src/Service/CoachService.php

    namespace App\Service;

    use App\Entity\Coach;
    use App\Repository\CoachRepository;
    use Doctrine\ORM\EntityManagerInterface;
    use Doctrine\ORM\Tools\Pagination\Paginator;
    use App\Exception\CoachNotFoundException;

    class CoachService
    {
        public function __construct(
            private EntityManagerInterface $entityManager,
            private CoachRepository $coachRepository
        ) {}

        public function createCoach(Coach $coach): Coach
        {
            $this->entityManager->persist($coach);
            $this->entityManager->flush();
            return $coach;
        }

        public function getAllCoaches(int $page, int $limit): array
        {
            $query = $this->coachRepository->createQueryBuilder('c')
                ->orderBy('c.name', 'ASC')
                ->getQuery()
                ->setFirstResult(($page - 1) * $limit)
                ->setMaxResults($limit);

            $paginator = new Paginator($query);
            $total = count($paginator);

            return [
                'coaches' => iterator_to_array($paginator->getIterator()),
                'total' => $total
            ];
        }

        public function deleteCoach(int $id): void
        {
            $coach = $this->coachRepository->find($id);

            if (!$coach) {
                throw new CoachNotFoundException();
            }

            $this->entityManager->remove($coach);
            $this->entityManager->flush();
        }
    }



# /src/Exception/AlreadyInClubException.php

    namespace App\Exception;

    use Symfony\Component\HttpKernel\Exception\HttpException;

    class AlreadyInClubException extends HttpException
    {
        public function __construct()
        {
            parent::__construct(409, "El jugador/entrenador ya pertenece a un club");
        }
    }



# /src/Exception/InsufficientBudgetException.php

    namespace App\Exception;

    use Symfony\Component\HttpKernel\Exception\HttpException;

    class InsufficientBudgetException extends HttpException
    {
        public function __construct(string $message = 'Presupuesto insuficiente')
        {
            parent::__construct(400, $message); // 400 Bad Request
        }
    }



# /src/Exception/ClubNotFoundException.php

    namespace App\Exception;

    use Symfony\Component\HttpKernel\Exception\HttpException;

    class ClubNotFoundException extends HttpException
    {
        public function __construct()
        {
            parent::__construct(404, "Club no encontrado");
        }
    }



# /src/Exception/PlayerNotFoundException.php

    namespace App\Exception;

    use Symfony\Component\HttpKernel\Exception\HttpException;

    class PlayerNotFoundException extends HttpException
    {
        public function __construct()
        {
            parent::__construct(404, "Jugador no encontrado");
        }
    }



# /src/Exception/CoachNotFoundException.php

    namespace App\Exception;

    use Symfony\Component\HttpKernel\Exception\HttpException;

    class CoachNotFoundException extends HttpException
    {
        public function __construct()
        {
            parent::__construct(404, "Entrendor no encontrado");
        }
    }